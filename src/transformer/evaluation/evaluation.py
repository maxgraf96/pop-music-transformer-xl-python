# =============================================
# This file contains the code used to evaluate the experiments
# =============================================

import pickle

import matplotlib.pyplot as plt
import numpy as np


def plot_losses(train_losses, val_losses):
    """
    Plot losses over epochs stored as dicts and show resulting image
    :param train_losses: Train loss dict
    :param val_losses: Validation loss dict
    :return: None
    """
    # Get number of epochs
    n_epochs = len(train_losses)
    # Get losses as lists
    train = list(train_losses.values())
    val = list(val_losses.values())
    # Plot
    plt.figure(dpi=200)
    plt.plot(np.linspace(1, n_epochs, n_epochs).astype(int), train)
    plt.plot(np.linspace(1, n_epochs, n_epochs).astype(int), val)
    plt.xlabel("Epoch")
    plt.ylabel("Loss")
    plt.show()


def plot_losses_from_pkl(train_losses_pkl_path, val_losses_pkl_path):
    """
    Same as above, but load pickled dicts
    :param train_losses_pkl_path: Path to train loss dict pkl file
    :param val_losses_pkl_path: Path to validation loss dict pkl file
    :return: None
    """
    with open(train_losses_pkl_path, "rb") as file:
        train_losses = pickle.load(file)
    with open(val_losses_pkl_path, "rb") as file:
        val_losses = pickle.load(file)

    plot_losses(train_losses, val_losses)


# Routine: Losses are hardcoded here as they were copied from the compute server IPython notebook
# output console except for C2, where they were saved as a pkl file
if __name__ == '__main__':
    # =================================
    # n_head=8
    # n_layer=12
    # d_inner=2048
    # dropout=0.1
    # =================================

    # C1_b_400_200_0.00005_n_head=8_n_layer=12_d_inner=2048_dropout=0.1 (stopped after 30 epochs)
    train_losses = {0: 4.6637783, 1: 3.885231, 2: 3.7241488, 3: 3.3310704, 4: 3.4944694, 5: 3.2223725, 6: 3.2783105,
                    7: 3.1993706, 8: 3.0729473, 9: 3.1616278, 10: 2.8772056, 11: 3.1133683, 12: 2.7934613,
                    13: 2.9619231, 14: 2.7648685, 15: 2.7370505, 16: 2.746935, 17: 2.5055137, 18: 2.69437,
                    19: 2.3014386, 20: 2.5402865, 21: 2.2010086, 22: 2.2857056, 23: 2.1336222, 24: 1.9629982,
                    25: 2.0075927, 26: 1.6589515, 27: 1.8753436, 28: 1.459553, 29: 1.6556547}
    val_losses = {0: 4.4125105047225945, 1: 3.986164943906996, 2: 3.764339530203077, 3: 3.713925671047635,
                  4: 3.749248799218072, 5: 3.754218659930759, 6: 3.794004315270318, 7: 3.8053095605638294,
                  8: 3.8283894422319205, 9: 3.8200408140818274, 10: 3.810135272873773, 11: 3.8295166911019214,
                  12: 3.8526179832882357, 13: 3.8889951854281954, 14: 3.952897612518735, 15: 3.9987250476413303,
                  16: 3.9989414021703933, 17: 4.013556629816691, 18: 4.051621740129259, 19: 4.047319004270765,
                  20: 4.154377256234487, 21: 4.173152509265476, 22: 4.282545180850558, 23: 4.286250693798065,
                  24: 4.346621982256571, 25: 4.359044723510743, 26: 4.397965663803948, 27: 4.470459693802728,
                  28: 4.499637008508046, 29: 4.5976567045847565}
    plot_losses(train_losses, val_losses)

    # C2_100_200_0.0001_n_head=8_n_layer=12_d_inner=2048_dropout=0.1 (stopped after 30 epochs)
    # Load pkl files and plot losses
    plot_losses_from_pkl('C2_100_200_0.0001_n_head=8_n_layer=12_d_inner=2048_dropout=0.1/train_losses.pkl',
                         'C2_100_200_0.0001_n_head=8_n_layer=12_d_inner=2048_dropout=0.1/val_losses.pkl')

    # =================================
    # n_head=6
    # n_layer=8
    # d_inner=1024
    # dropout=0.3
    # =================================

    # C3_400_200_0.0001_n_head=6_n_layer=8_d_inner=1024_dropout=0.3
    train_losses = {0: 4.7929764, 1: 4.1435623, 2: 3.8380063, 3: 3.4273007, 4: 3.5194168, 5: 3.2676797, 6: 3.2953446,
                    7: 3.1987484, 8: 3.0775056, 9: 3.1371462, 10: 2.8563943, 11: 3.0264094, 12: 2.7357514,
                    13: 2.8588748,
                    14: 2.654955, 15: 2.672954, 16: 2.652901, 17: 2.4343069, 18: 2.589776, 19: 2.2776537, 20: 2.4598489,
                    21: 2.1811094, 22: 2.282755, 23: 2.1393626, 24: 2.0418873, 25: 2.1101878, 26: 1.8391802,
                    27: 2.0413773,
                    28: 1.7149967, 29: 1.9097595, 30: 1.6779941}
    val_losses = {0: 4.491157988972134, 1: 4.115622506141663, 2: 3.834483313560486, 3: 3.700980776151021,
                  4: 3.7984436040454437, 5: 3.766084357102712, 6: 3.83282252629598, 7: 3.80315655681822,
                  8: 3.863705789777968, 9: 3.797960733572642, 10: 3.7999980995390152, 11: 3.7675857175721057,
                  12: 3.738283763461643, 13: 3.8436908965640595, 14: 3.8219100178612604, 15: 3.8313578576511804,
                  16: 3.8464790950881107, 17: 3.8435808261235556, 18: 3.8729351981480917, 19: 3.8156347378094986,
                  20: 3.9346141439014013, 21: 3.9540699529647827, 22: 4.016901129881541, 23: 4.04046772427029,
                  24: 4.051030302577549, 25: 4.074912968741523, 26: 4.070014898777008, 27: 4.109299834039477,
                  28: 4.037050192621019, 29: 4.2172283887863165, 30: 4.272471890449523}
    plot_losses(train_losses, val_losses)

    # C4_400_200_0.00005_n_head=6_n_layer=8_d_inner=1024_dropout=0.3 (stopped after 30 epochs)
    train_losses = {0: 4.962041, 1: 4.55457, 2: 4.111458, 3: 3.678572, 4: 3.6407213, 5: 3.4290278, 6: 3.4182372,
                    7: 3.3086405,
                    8: 3.2226052, 9: 3.2636046, 10: 3.0889661, 11: 3.1890664, 12: 3.0058672, 13: 3.0855522,
                    14: 2.970766,
                    15: 2.973125, 16: 2.9219525, 17: 2.7603462, 18: 2.8330061, 19: 2.629822, 20: 2.7407086,
                    21: 2.5738933,
                    22: 2.6414857, 23: 2.5493212, 24: 2.493726, 25: 2.5443332, 26: 2.3613534, 27: 2.4957726,
                    28: 2.2631252,
                    29: 2.3961442, 30: 2.257579, 31: 2.279808, 32: 2.221448}

    val_losses = {0: 4.683476876682706, 1: 4.399216655625237, 2: 4.030291906992594, 3: 3.843195868068271,
                  4: 3.8148236592610676, 5: 3.7439452025625446, 6: 3.790317595269945, 7: 3.7886194192038647,
                  8: 3.818484869003296, 9: 3.846470236248441, 10: 3.850440956486596, 11: 3.8757125584284466,
                  12: 3.8356484720442032, 13: 3.900182326899635, 14: 3.9328228092193607, 15: 3.926463916036818,
                  16: 3.8473681219418845, 17: 3.8245510864257812, 18: 3.8063607986768093, 19: 3.778036825127072,
                  20: 3.833620646529728, 21: 3.812706162134807, 22: 3.837446201642354, 23: 3.791818066438039,
                  24: 3.823932319482168, 25: 3.8734919929504397, 26: 3.887751851611667, 27: 3.9570885319179956,
                  28: 3.9076591282420687, 29: 3.985464259783427, 30: 4.038878633711074, 31: 4.011025136576759,
                  32: 4.007529651323954}
    plot_losses(train_losses, val_losses)

    # C5_untie_r=False_200_200_0.00005_n_head=8_n_layer=12_d_inner=2048_dropout=0.1
    train_losses = {0: 4.7357044, 1: 3.8091877, 2: 3.5448914, 3: 3.3841891, 4: 3.2992504, 5: 3.2192888, 6: 3.1490774,
                    7: 3.0705602, 8: 2.9853046, 9: 2.919959, 10: 2.8146038, 11: 2.6962144, 12: 2.6191077, 13: 2.466744,
                    14: 2.3144517, 15: 2.1992593, 16: 2.0266783, 17: 1.8630188, 18: 1.6381792, 19: 1.5107474,
                    20: 1.3287549,
                    21: 1.2323518, 22: 1.1792002, 23: 1.1118776, 24: 1.088694, 25: 1.0588173, 26: 1.0467654,
                    27: 1.1376898,
                    28: 1.0663971, 29: 1.0034035, 30: 1.0212215, 31: 1.0004921, 32: 1.042577, 33: 1.058759}

    val_losses = {0: 4.689969105947585, 1: 4.116983489600979, 2: 4.032519116693614, 3: 4.089567433084761,
                  4: 4.06511540996785, 5: 4.164283131579964, 6: 4.234779749030159, 7: 4.19344883257029,
                  8: 4.203738038393916,
                  9: 4.241262205279603, 10: 4.346983964102609, 11: 4.366685589965509, 12: 4.406265275332393,
                  13: 4.469493783087958, 14: 4.491602692312124, 15: 4.608626968520028, 16: 4.736907566161382,
                  17: 4.786467472874388, 18: 4.891959524154664, 19: 5.000031245484643, 20: 5.035231434731256,
                  21: 5.139606712302382, 22: 5.181735463045081, 23: 5.182293451967694, 24: 5.282184147348209,
                  25: 5.322576648848398, 26: 5.474922868183682, 27: 5.503480891792142, 28: 5.352194336482456,
                  29: 5.494887036693339, 30: 5.466832643463498, 31: 5.450226821704787, 32: 5.390046670485516,
                  33: 5.4578766345977785}
    plot_losses(train_losses, val_losses)

    # C6
    train_losses = {0: 4.194603, 1: 3.6235976, 2: 3.5110998, 3: 3.4478939, 4: 3.3838406, 5: 3.3364675, 6: 3.2267637,
                    7: 3.069816, 8: 2.9087646, 9: 2.8077486, 10: 2.6760573, 11: 2.5390348, 12: 2.377542, 13: 2.2282827,
                    14: 2.0539181, 15: 1.8722032, 16: 1.7023888, 17: 1.5673716, 18: 1.4055179, 19: 1.2740653,
                    20: 1.1878257,
                    21: 1.1537316, 22: 1.1171938, 23: 1.0913649, 24: 1.0487729, 25: 1.0495752, 26: 1.0528228,
                    27: 1.0315744,
                    28: 1.0335969, 29: 1.0256661, 30: 1.0358061, 31: 1.0289358, 32: 1.0039371, 33: 1.0127118,
                    34: 1.0016817,
                    35: 0.98930615, 36: 0.9833942, 37: 1.0075502, 38: 0.9922076, 39: 0.9826857, 40: 1.0062317,
                    41: 0.96303374,
                    42: 0.987167, 43: 0.98202026, 44: 0.9756559, 45: 0.9783813, 46: 0.9909797, 47: 0.9587199,
                    48: 0.946539,
                    49: 0.95199686, 50: 0.9924931}
    val_losses = {0: 4.080163655545977, 1: 3.69397452155749, 2: 3.6434333751598995, 3: 3.620645890169673,
                  4: 3.599296043051614, 5: 3.598427140646511, 6: 3.5679796304305396, 7: 3.4103335687186984,
                  8: 3.317426314618852, 9: 3.3028189912769523, 10: 3.2826247282160654, 11: 3.2845438604222403,
                  12: 3.2961127628551585, 13: 3.358061110907131, 14: 3.382212162415187, 15: 3.4858622929122713,
                  16: 3.594558455281787, 17: 3.7192860974868136, 18: 3.8119890344805185, 19: 3.9092300991879574,
                  20: 3.9658358789152564, 21: 4.053421102762223, 22: 4.120158732202318, 23: 4.152319278717041,
                  24: 4.169785136812262, 25: 4.190378074414201, 26: 4.188075687289238, 27: 4.196237589153977,
                  28: 4.277162525388929, 29: 4.329032162593471, 30: 4.303511354227862, 31: 4.255170538127422,
                  32: 4.334745847317908, 33: 4.328055904474525, 34: 4.313071181608571, 35: 4.241650163200167,
                  36: 4.272075017227067, 37: 4.3290660699870855, 38: 4.378499850763214, 39: 4.3560585532254645,
                  40: 4.380357671744295, 41: 4.402938433024619, 42: 4.368467989729511, 43: 4.381585563355022,
                  44: 4.350143509308498, 45: 4.339998680750528, 46: 4.367748038934336, 47: 4.383282495869531,
                  48: 4.428522541522979, 49: 4.371703466475009, 50: 4.462615130080118}
    plot_losses(train_losses, val_losses)